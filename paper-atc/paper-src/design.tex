In this section, we first introduce the design principles of HGFRR (Section \cref{principles}). Then we present the topology of the network (Section \cref{topo}), how the structure is formed (Section \cref{formation}) and maintained (Section \cref{maintain}), and the broadcast algorithm (Section \cref{broadcast}). Security issues are also addressed in the design of HGFRR (Section \cref{security}).

\subsection{Design Principles} \label{principles}

The design of HGFRR as a Peer-to-Peer network layer under a blockchain system follows four principles:
\noindent
\begin{itemize}[noitemsep, topsep=0pt]
	\item Fair: An unfair P2P network may ascend free-riders, frustrate majority of users and consequently lead to instability of the network \cite{naghizadeh2016improving}.
	\item Self-organizing: No central server should be responsible for organizing the structure of the network. In other words, the decentralization nature of the P2P network should not be affected.
	\item Anonymous: Each node in the network and the network topology should be hidden from the outsider so that target attack can be avoided to some extent.
	\item Efficient on broadcast: The converge time of each message to broadcast should be as small as possible. Therefore, the number of concurrent messages on flight will be reduced.
	\item Robust in the dynamic environment: The network is unstable due to the frequent disconnection or node-join. The structure of the network should be easy to maintain in a distributed manner.
	\item Scalable to large number of nodes: The P2P network should be able to scale up to tremendous number of nodes as a public block chain may grow up to millions of nodes.
\end{itemize}

\subsection{Topology} \label{topo}

Talk about the p2p network structure. [TODO: add figure]

The network topology is basically a recursive ring-fractal structure. At the top level resides the largest ring where several sub-ring resides on. The figure shows a network of 3 levels. Level 1 is the largest ring. On the largest ring, there are three sub-rings of 2 levels. Level 2 is the second largest ring and level 3 is the smallest ring. The nodes in red are contact nodes.

Before presenting the protocol, several key concepts should be defined clearly:
\begin{itemize}[noitemsep, topsep=0pt]
	\item Node: One instance of a server/virtual machine in the network;
	\item Ring: A group of nodes connected in a ring-like structure.
	\item Contact Node: the node on the ring who is in charge of adding new nodes, contacting the nodes in the upper level of the network, and broadcasting the message.
\end{itemize}

\subsubsection{Structure Formation} \label{formation}

Talk about the p2p network formation. boostrap.

\textbf{Node-Join} is the process of a new node joining the network. When a new node wants to join the network, it will send message to the contact nodes of the largest ring. The contact node will judge which sub-ring this new node should be added to, based on some metrics related to locality. Recursively, the contact node of the sub-ring will then introduce the new node to the sub-sub-ring. In the end, the contact node of a ring in the lowest level will then add the new node to the ring.

If the number of node on a ring exceeds a threshold, then this ring will transform to a two-level ring (See Figure 4.2), i.e. several groups of nodes on the large ring will form several rings.

\subsubsection{Structure Maintenance} \label{maintain}

Talk about the p2p network maintenance.

\textbf{Node-Leave} is the process of the network reacting to node-leave. Each node on the ring will send heart-beat messages to its successor and predecessor to check the aliveness of them. Once a node are not responding to the heart-beat message, the node will double check this with the neighbor of the dead node. If they agree that this node left the network (intentionally or accidentally), the information will be disseminated to the ring and this node will be officially removed from the network.

If the missing node is the contact node, then the next generation of contact node(s) will be elected. If the number of nodes on the ring is smaller than the lower limit, a transformation from right to left in Figure 4.2 will be performed.

\subsection{Broadcast} \label{broadcast}

Talk about broadcast mechanism.

\textbf{Broadcast} is the process of disseminating a message from one node to the whole network. When a node wants to send a message to the whole network, it will first contact the contact node of the ring it resides on. Then the message will be routed to two directions: one direction is downwards, i.e. the contact node will broadcast the message in the ring and recursively in the sub-rings; the other direction is upwards, i.e. the contact node will find the contact node of the largest ring by recursively contacting the contact node in the upper level. Once the contact node in the largest ring is found, it will broadcast recursively in the rings and sub-rings.

We devised a k-ary distributed spanning tree method to broadcast message in a ring. Details will be presented in the subsection. Based on this method, the time complexity of broadcast will be $O(logN)$ and message complexity will be $(O(N))$, which are currently the best among related works.

\subsubsection{Broadcast Within-Ring Mechanism}

We devised a k-ary distributed spanning tree method to facilitate the in-ring broadcast in the protocol. The basic idea is to generate a random number $k$, form a k-ary spanning tree, and broadcast from the root to every node in the tree. The reason we choose to randomize the parameter k is that the network should be hidden from the attacker. If it keeps using the same k, the routing pattern will be known easily by watching the network activities for a long time. The spanning tree are formed by using the broadcaster (which is numbered 0) as the root. Node 0 will connect to node $0+k^0$, $0+k^1$, $0+k^2$, and so on. Similarly, node 1 will connect to $1+k^0$, $1+k^1$, $1+k^2$, and so on. The pattern is: node $i$ will connect to $i+k^0$, $i+k^1$, $i+k^2$, and so on. The overall time complexity of this method will be $O(logN)$, where $N$ is the number of nodes in the ring. 

For example, Figure 4.3(a) shows a ring of 10 nodes numbered from 0 to 9. As the k-ary spanning tree algorithm states, when $k=2$: node 0 will connect to node 1, 2, 4, 8; node 1 will connect to node 3, 5, 9; node 2 will connect to node 6; node 3 will connect to node 7. After a spanning tree is formed (see Figure 4.3(b)), the message will be disseminated from node 0 down to every node in the spanning tree.


\subsection{Security Consideration} \label{security}

Talk about the usage of Intel SGX, fake messages, contact node election.